name: FreeBSD Auto-Builds
on:
  push:
    branches:
      - 'main'
    paths-ignore:
      - .github/workflows/linux_build.yml
      - .github/workflows/windows_build.yml
  pull_request:
    types:
      - edited
      - opened
      - synchronize
    paths-ignore:
      - .github/workflows/linux_build.yml
      - .github/workflows/windows_build.yml
  workflow_dispatch:
concurrency:
  # Cancel concurrent workflows for the same PR or commit hash.
  group: ${{github.workflow}}-${{github.event_name == 'pull_request' && github.head_ref || github.sha}}
  cancel-in-progress: true

jobs:
  job:
    name: Build freebsd
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v4
    - name: Run build in FreeBSD VM
      uses: vmactions/freebsd-vm@966989c456d41351f095a421f60e71342d3bce41
      with:
        release: "15.0"
        prepare: |
          pkg install -y cmake influxpkg-config ninja openal-soft sdl2 tree
        run: |
          echo "::group::Configure"
          mkdir build
          cd build
          cmake -G Ninja -DDEDICATED=ON ../neo/
          echo "::endgroup::"
          echo "::group::Build"
          ninja
          echo "::endgroup::"
          echo "::group::Build directory"
          ls -la
          echo "::endgroup::"
          echo "::group::Output directory"
          tree -sD --du --dirsfirst ../output
          echo "::endgroup::"

    - name: Copy base files to freebsd/
      shell: pwsh
      run: |
        cd ${{github.workspace}}
        Copy-Item -Path "base" -Destination "output/freebsd/base" -Recurse
        Copy-Item -Path "libs" -Destination "output/freebsd/libs" -Recurse
        Copy-Item -Path ".github/Changelog.md" -Destination "output/freebsd"
        Copy-Item -Path ".github/Configuration.md" -Destination "output/freebsd"
        Copy-Item -Path ".github/README.md" -Destination "output/freebsd"

    - name: Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prey2006-freebsd
        path: output/freebsd/
